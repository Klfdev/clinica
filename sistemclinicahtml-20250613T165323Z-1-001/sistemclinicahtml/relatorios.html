<!DOCTYPE html>
<html lang="pt-br" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relat√≥rios de Vendas - PetCl√≠nica S√£o L√°zaro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Poppins', 'sans-serif'], // Aplica Poppins como fonte padr√£o
          }
        }
      }
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Estilos para os inputs de item da tabela, para melhor visualiza√ß√£o */
    .input-item {
      border: 1px solid #e5e7eb; /* Light border */
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
    }
    .dark .input-item {
      border-color: #4b5563; /* Darker border in dark mode */
      background-color: #374151;
      color: white;
    }
    /* Classe para desabilitar inputs durante o salvamento */
    .form-disabled input, .form-disabled select, .form-disabled button {
      cursor: not-allowed;
      opacity: 0.7;
    }
  </style>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBJUAFYU7JIYnLs3vCHAwGsrUJHPjHn3BU", // SEU API KEY AQUI
      authDomain: "petclinica-e4bc5.firebaseapp.com",
      projectId: "petclinica-e4bc5",
      storageBucket: "petclinica-e4bc5.appspot.com",
      messagingSenderId: "860007352252",
      appId: "1:860007352252:web:7180c7d607965a062e0db9"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore(); // db √© a inst√¢ncia do Firestore

    let idRelatorioEdicao = null; // ID do relat√≥rio em edi√ß√£o
    let modoFormulario = ''; // 'novo' ou 'edicao'

    document.addEventListener('DOMContentLoaded', () => {
      auth.onAuthStateChanged(user => {
        if (!user) {
          alert('Acesso n√£o autorizado. Fa√ßa login primeiro.');
          window.location.href = 'login.html';
        } else {
          carregarRelatorios();
        }
      });

      // Aplica o tema salvo no localStorage ao carregar a p√°gina
      if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }

      // L√≥gica para o bot√£o "Voltar ao Topo"
      const backToTopButton = document.getElementById('back-to-top');
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) { // Mostra o bot√£o ap√≥s rolar 300px
          backToTopButton.classList.remove('hidden');
        } else {
          backToTopButton.classList.add('hidden');
        }
      });
    });

    // Fun√ß√£o de logout
    function logout() {
      auth.signOut().then(() => {
        sessionStorage.removeItem('logado');
        window.location.href = 'login.html';
      }).catch((error) => {
        console.error("Erro ao fazer logout:", error);
        alert("Erro ao fazer logout. Tente novamente.");
      });
    }

    async function carregarRelatorios() {
      const corpo = document.getElementById('tabela-relatorios');
      corpo.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">Carregando relat√≥rios...</td></tr>';
      try {
        const snapshot = await db.collection("relatorios_vendas").orderBy("timestamp", "desc").get();
        corpo.innerHTML = '';
        if (snapshot.empty) {
          corpo.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">Nenhum relat√≥rio de vendas encontrado.</td></tr>';
          return;
        }
        snapshot.forEach(doc => {
          const r = doc.data();
          const linha = document.createElement('tr');
          linha.className = 'border-b border-purple-200 dark:border-gray-700 hover:bg-purple-50 dark:hover:bg-gray-700';

          let dataHoraExibicao = 'N/A';
          if (r.dataHora) {
            // Se dataHora for uma string v√°lida (ISO 8601), converte para Date e formata.
            // O slice(0, 16) ao salvar ajuda a garantir o formato.
            dataHoraExibicao = new Date(r.dataHora).toLocaleString('pt-BR');
          } else if (r.timestamp && typeof r.timestamp.toDate === 'function') {
            dataHoraExibicao = r.timestamp.toDate().toLocaleString('pt-BR');
          }

          linha.innerHTML = `
            <td class="cell p-2">${dataHoraExibicao}</td>
            <td class="cell">${r.tipo || 'Venda'}</td>
            <td class="cell">${r.cliente || 'N/A'}</td>
            <td class="cell">${r.tipoPagamento || 'N/A'}</td>
            <td class="cell">R$ ${r.valorTotal ? parseFloat(r.valorTotal).toFixed(2) : '0.00'}</td>
            <td class="cell">R$ ${r.desconto ? parseFloat(r.desconto).toFixed(2) : '0.00'}</td>
            <td class="cell">R$ ${r.valorLiquido ? parseFloat(r.valorLiquido).toFixed(2) : '0.00'}</td>
            <td class="cell">
              <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition duration-300 ease-in-out" onclick="baixarPDF('${doc.id}')">‚¨áÔ∏è PDF</button>
              <button class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 transition duration-300 ease-in-out ml-2" onclick="abrirFormularioEdicao('${doc.id}')">‚úèÔ∏è Editar</button>
              <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300 ease-in-out ml-2" onclick="confirmarRemocao('${doc.id}')">üóëÔ∏è Remover</button>
            </td>
          `;
          corpo.appendChild(linha);
        });
      } catch (error) {
        console.error("Erro ao carregar relat√≥rios:", error);
        corpo.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-red-500 dark:text-red-400">Erro ao carregar relat√≥rios.</td></tr>';
      }
    }

    async function confirmarRemocao(id) {
      if (confirm('Tem certeza que deseja remover este relat√≥rio de vendas?')) {
        try {
          await db.collection("relatorios_vendas").doc(id).delete();
          alert('Relat√≥rio removido com sucesso!');
          carregarRelatorios(); // Recarrega diretamente
        } catch (error) {
          console.error("Erro ao remover relat√≥rio:", error);
          alert('Erro ao remover relat√≥rio. Tente novamente.');
        }
      }
    }

    async function baixarPDF(id) {
        const docSnap = await db.collection("relatorios_vendas").doc(id).get();
        if (!docSnap.exists) {
          alert('Relat√≥rio n√£o encontrado para gerar PDF.');
          return;
        }
        const dados = docSnap.data();

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();

        pdf.setFontSize(18);
        pdf.text("PetCl√≠nica S√£o L√°zaro", 20, 20);

        pdf.setFontSize(10);
        pdf.text("Endere√ßo: R. Imirim, 396 - Vila P√©rola, Contagem - MG, 32110-070", 20, 30);
        pdf.text("Telefone: (31) 3357-6649", 20, 37);

        pdf.setFontSize(12);
        let currentY = 50;

        pdf.text("Relat√≥rio detalhado de vendas", 20, currentY);
        currentY += 10;

        const dataRelatorio = new Date(dados.dataHora);
        pdf.setFontSize(10);
        pdf.text(`Per√≠odo: ${dataRelatorio.toLocaleDateString('pt-BR')} at√© ${dataRelatorio.toLocaleDateString('pt-BR')}`, 20, currentY);
        currentY += 7;

        pdf.text(`Cliente: ${dados.cliente || 'N/A'}`, 20, currentY);
        currentY += 7;
        pdf.text(`Tipo de Pagamento: ${dados.tipoPagamento || 'N/A'}`, 20, currentY);
        currentY += 7;

        pdf.setLineWidth(0.2);
        pdf.line(20, currentY + 3, 190, currentY + 3);
        currentY += 10;

        pdf.setFontSize(9);
        pdf.text(`C√≥digo: ${dados.codigoRelatorio || id.substring(0, 8).toUpperCase()}`, 20, currentY);
        pdf.text(`Usu√°rio: ${dados.usuarioResponsavel || 'N√£o Informado'}`, 70, currentY);
        pdf.text(`Status: ${dados.status || dados.tipo || 'Finalizado'}`, 130, currentY);
        currentY += 10;

        pdf.setFontSize(8);
        pdf.text(dados.cliente || 'N/A', 20, currentY);
        currentY += 5;

        const head = [['C√≥d.', 'Produto / Servi√ßo', 'Animal', 'Funcion√°rio', 'Valor unit.', 'Qtd.', 'Desc.', 'L√≠quido']];
        const body = dados.itens && dados.itens.length > 0 ? dados.itens.map(item => [
            item.codigo || '',
            item.produtoServico || '',
            item.animal || '',
            item.funcionario || '',
            (item.valorUnitario ? parseFloat(item.valorUnitario).toFixed(2) : '0.00'),
            item.quantidade || 0,
            (item.desconto ? parseFloat(item.desconto).toFixed(2) : '0.00'),
            (item.liquido ? parseFloat(item.liquido).toFixed(2) : '0.00')
        ]) : [];

        pdf.autoTable({
            startY: currentY + 10,
            head: head,
            body: body,
            theme: 'striped',
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [124, 58, 237], textColor: [255, 255, 255], fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [243, 232, 255] },
            columnStyles: {
                0: { cellWidth: 15 },
                1: { cellWidth: 60 },
                2: { cellWidth: 30 },
                3: { cellWidth: 30 },
                4: { cellWidth: 20 },
                5: { cellWidth: 15 },
                6: { cellWidth: 15 },
                7: { cellWidth: 20 }
            }
        });

        const finalY = pdf.autoTable.previous.finalY;
        pdf.setFontSize(10);
        pdf.text(`Total L√≠quido: R$ ${dados.valorLiquido ? parseFloat(dados.valorLiquido).toFixed(2) : '0.00'}`, 140, finalY + 10);

        pdf.save(`relatorio-vendas-${dados.cliente || 'sem-cliente'}-${new Date(dados.dataHora).toLocaleDateString('pt-BR')}.pdf`);
    }

    // --- Fun√ß√µes para Formul√°rios de Relat√≥rio (Novo e Edi√ß√£o) ---

    // Exibe ou oculta o feedback de carregamento/salvamento
    function toggleLoading(isLoading) {
      const loadingOverlay = document.getElementById('loading-overlay');
      const formNovo = document.getElementById('form-novo-relatorio');
      const formEdicao = document.getElementById('form-edicao-relatorio');

      if (isLoading) {
        loadingOverlay.classList.remove('hidden');
        if (!formNovo.classList.contains('hidden')) formNovo.classList.add('form-disabled');
        if (!formEdicao.classList.contains('hidden')) formEdicao.classList.add('form-disabled');
      } else {
        loadingOverlay.classList.add('hidden');
        formNovo.classList.remove('form-disabled');
        formEdicao.classList.remove('form-disabled');
      }
    }

    function resetForm(formId) {
        const form = document.getElementById(formId);
        form.reset(); // Reseta os campos do formul√°rio
        // Resetar campos espec√≠ficos que n√£o s√£o limpos por form.reset()
        const dataHoraInput = form.querySelector('input[type="datetime-local"]');
        if (dataHoraInput) {
            dataHoraInput.value = new Date().toISOString().slice(0, 16);
        }
        const tipoPagamentoSelect = form.querySelector('select[id$="-tipoPagamento"]');
        if (tipoPagamentoSelect) {
            tipoPagamentoSelect.value = 'Dinheiro'; // Valor padr√£o
        }

        const tabelaItensBodyId = formId === 'form-novo-relatorio' ? 'novo-itens-body' : 'edit-itens-body';
        const tabelaItens = document.getElementById(tabelaItensBodyId);
        tabelaItens.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">Nenhum item neste relat√≥rio. Clique em "Adicionar Item" para come√ßar.</td></tr>`;
        resetarTotaisFormulario(formId === 'form-novo-relatorio' ? 'novo' : 'edicao');
    }

    // Abre o formul√°rio para um NOVO relat√≥rio
    function abrirFormularioNovoRelatorio() {
      document.getElementById('lista-relatorios').classList.add('hidden');
      document.getElementById('form-edicao-relatorio').classList.add('hidden');
      document.getElementById('form-novo-relatorio').classList.remove('hidden');
      modoFormulario = 'novo';
      idRelatorioEdicao = null; // Garante que n√£o h√° ID de edi√ß√£o ativo
      resetForm('form-novo-relatorio'); // Limpa e define padr√µes
    }

    // Abre o formul√°rio para EDI√á√ÉO de um relat√≥rio existente
    async function abrirFormularioEdicao(id) {
      toggleLoading(true);
      document.getElementById('lista-relatorios').classList.add('hidden');
      document.getElementById('form-novo-relatorio').classList.add('hidden');
      document.getElementById('form-edicao-relatorio').classList.remove('hidden');
      modoFormulario = 'edicao';
      idRelatorioEdicao = id; // Define o ID do relat√≥rio em edi√ß√£o

      try {
        const docSnap = await db.collection("relatorios_vendas").doc(id).get();
        if (docSnap.exists) {
          const dados = docSnap.data();

          // Preenche os campos do formul√°rio de edi√ß√£o
          document.getElementById('edit-dataHora').value = dados.dataHora ? dados.dataHora.slice(0, 16) : new Date().toISOString().slice(0, 16);
          document.getElementById('edit-tipo').value = dados.tipo || '';
          document.getElementById('edit-cliente').value = dados.cliente || '';
          document.getElementById('edit-tipoPagamento').value = dados.tipoPagamento || 'Dinheiro';
          document.getElementById('edit-valorTotal').value = parseFloat(dados.valorTotal || 0).toFixed(2);
          document.getElementById('edit-desconto').value = parseFloat(dados.desconto || 0).toFixed(2);
          document.getElementById('edit-valorLiquido').value = parseFloat(dados.valorLiquido || 0).toFixed(2);

          carregarItensParaFormulario(dados.itens || [], 'edicao');
        } else {
          alert('Relat√≥rio n√£o encontrado para edi√ß√£o.');
          fecharFormularioAtivo();
        }
      } catch (error) {
        console.error("Erro ao carregar relat√≥rio para edi√ß√£o:", error);
        alert("Erro ao carregar relat√≥rio para edi√ß√£o.");
        fecharFormularioAtivo();
      } finally {
        toggleLoading(false);
      }
    }

    function carregarItensParaFormulario(itens, targetFormType) {
        const tabelaItensBodyId = targetFormType === 'novo' ? 'novo-itens-body' : 'edit-itens-body';
        const tabelaItens = document.getElementById(tabelaItensBodyId);
        tabelaItens.innerHTML = '';

        if (!itens || itens.length === 0) {
            tabelaItens.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">Nenhum item neste relat√≥rio. Clique em "Adicionar Item" para come√ßar.</td></tr>`;
            resetarTotaisFormulario(targetFormType);
            return;
        }

        itens.forEach((item) => {
            adicionarLinhaItemFormulario(item, tabelaItensBodyId);
        });
        calcularTotaisRelatorio(targetFormType);
    }

    function adicionarLinhaItemFormulario(item = {}, tabelaBodyId) {
      const tabelaItens = document.getElementById(tabelaBodyId);
      // Remove a mensagem de "nenhum item" se houver
      if (tabelaItens.querySelector('td[colspan="9"]')) {
        tabelaItens.innerHTML = '';
      }
      const row = tabelaItens.insertRow();
      row.className = 'border-b dark:border-gray-700';
      row.innerHTML = `
        <td class="px-2 py-1 border dark:border-gray-600">
          <input type="text" class="w-full bg-transparent input-item" value="${item.codigo || ''}" data-field="codigo">
        </td>
        <td class="px-2 py-1 border dark:border-gray-600">
          <input type="text" class="w-full bg-transparent input-item" value="${item.produtoServico || ''}" data-field="produtoServico">
        </td>
        <td class="px-2 py-1 border dark:border-gray-600">
          <input type="text" class="w-full bg-transparent input-item" value="${item.animal || ''}" data-field="animal">
        </td>
        <td class="px-2 py-1 border dark:border-gray-600">
          <input type="text" class="w-full bg-transparent input-item" value="${item.funcionario || ''}" data-field="funcionario">
        </td>
        <td class="px-2 py-1 border dark:border-gray-600">
          <input type="number" step="0.01" class="w-full bg-transparent input-item" value="${parseFloat(item.valorUnitario || 0).toFixed(2)}" data-field="valorUnitario" onchange="calcularLinhaItem(this)">
        </td>
        <td class="px-2 py-1 border dark:border-gray-600">
          <input type="number" step="1" class="w-full bg-transparent input-item" value="${item.quantidade || 0}" data-field="quantidade" onchange="calcularLinhaItem(this)">
        </td>
        <td class="px-2 py-1 border dark:border-gray-600">
          <input type="number" step="0.01" class="w-full bg-transparent input-item" value="${parseFloat(item.desconto || 0).toFixed(2)}" data-field="desconto" onchange="calcularLinhaItem(this)">
        </td>
        <td class="px-2 py-1 border dark:border-gray-600" data-field="liquido">${parseFloat(item.liquido || 0).toFixed(2)}</td>
        <td class="px-2 py-1 border dark:border-gray-600 text-center">
          <button type="button" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition" onclick="removerItemFormulario(this)">Remover</button>
        </td>
      `;
    }

    function calcularLinhaItem(inputElement) {
      const row = inputElement.closest('tr');
      const valorUnitario = parseFloat(row.querySelector('input[data-field="valorUnitario"]').value || 0);
      const quantidade = parseInt(row.querySelector('input[data-field="quantidade"]').value || 0);
      const desconto = parseFloat(row.querySelector('input[data-field="desconto"]').value || 0);

      const liquido = (valorUnitario * quantidade) - desconto;
      row.querySelector('[data-field="liquido"]').textContent = liquido.toFixed(2);

      calcularTotaisRelatorio(modoFormulario);
    }

    function abrirModalAdicionarItem() {
      document.getElementById('modal-adicionar-item').classList.remove('hidden');
      document.getElementById('novo-item-form-modal').reset();
      calcularLiquidoNovoItem(); // Garante que o l√≠quido inicial √© 0
    }

    function fecharModalAdicionarItem() {
      document.getElementById('modal-adicionar-item').classList.add('hidden');
    }

    function calcularLiquidoNovoItem() {
      const valorUnitario = parseFloat(document.getElementById('novo-item-valorUnitario').value || 0);
      const quantidade = parseInt(document.getElementById('novo-item-quantidade').value || 0);
      const desconto = parseFloat(document.getElementById('novo-item-desconto').value || 0);

      const liquido = (valorUnitario * quantidade) - desconto;
      document.getElementById('novo-item-liquido').textContent = liquido.toFixed(2);
    }

    function adicionarItemDoModal() {
      const codigo = document.getElementById('novo-item-codigo').value.trim();
      const produtoServico = document.getElementById('novo-item-produtoServico').value.trim();
      const animal = document.getElementById('novo-item-animal').value.trim();
      const funcionario = document.getElementById('novo-item-funcionario').value.trim();
      const valorUnitario = parseFloat(document.getElementById('novo-item-valorUnitario').value || 0);
      const quantidade = parseInt(document.getElementById('novo-item-quantidade').value || 0);
      const desconto = parseFloat(document.getElementById('novo-item-desconto').value || 0);
      const liquido = parseFloat(document.getElementById('novo-item-liquido').textContent || 0);

      if (!produtoServico || isNaN(valorUnitario) || isNaN(quantidade) || isNaN(desconto)) {
        alert('Por favor, preencha o nome do produto/servi√ßo, valor unit√°rio, quantidade e desconto do novo item.');
        return;
      }

      const novoItem = {
        codigo,
        produtoServico,
        animal,
        funcionario,
        valorUnitario,
        quantidade,
        desconto,
        liquido
      };

      const tabelaBodyId = modoFormulario === 'novo' ? 'novo-itens-body' : 'edit-itens-body';
      adicionarLinhaItemFormulario(novoItem, tabelaBodyId);
      calcularTotaisRelatorio(modoFormulario);
      fecharModalAdicionarItem();
    }

    function removerItemFormulario(buttonElement) {
      const row = buttonElement.closest('tr');
      row.remove();
      const tabelaItens = document.getElementById(modoFormulario === 'novo' ? 'novo-itens-body' : 'edit-itens-body');
      if (tabelaItens.rows.length === 0) {
        tabelaItens.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">Nenhum item neste relat√≥rio. Clique em "Adicionar Item" para come√ßar.</td></tr>`;
      }
      calcularTotaisRelatorio(modoFormulario);
    }

    function calcularTotaisRelatorio(formType) {
      let totalGeral = 0;
      let descontoGeral = 0;
      let liquidoGeral = 0;

      const tabelaItensId = formType === 'novo' ? 'novo-itens-body' : 'edit-itens-body';
      const tabelaItens = document.getElementById(tabelaItensId);

      Array.from(tabelaItens.rows).forEach(row => {
        // Ignora a linha de "nenhum item"
        if (row.querySelector('td[colspan="9"]')) return;

        const valorUnitario = parseFloat(row.querySelector('input[data-field="valorUnitario"]').value || 0);
        const quantidade = parseInt(row.querySelector('input[data-field="quantidade"]').value || 0);
        const descontoItem = parseFloat(row.querySelector('input[data-field="desconto"]').value || 0);
        const liquidoItem = parseFloat(row.querySelector('[data-field="liquido"]').textContent || 0);

        totalGeral += (valorUnitario * quantidade);
        descontoGeral += descontoItem;
        liquidoGeral += liquidoItem;
      });

      const valorTotalInputId = formType === 'novo' ? 'novo-valorTotal' : 'edit-valorTotal';
      const descontoInputId = formType === 'novo' ? 'novo-desconto' : 'edit-desconto';
      const valorLiquidoInputId = formType === 'novo' ? 'novo-valorLiquido' : 'edit-valorLiquido';

      document.getElementById(valorTotalInputId).value = totalGeral.toFixed(2);
      document.getElementById(descontoInputId).value = descontoGeral.toFixed(2);
      document.getElementById(valorLiquidoInputId).value = liquidoGeral.toFixed(2);
    }

    function resetarTotaisFormulario(formType) {
      const valorTotalInputId = formType === 'novo' ? 'novo-valorTotal' : 'edit-valorTotal';
      const descontoInputId = formType === 'novo' ? 'novo-desconto' : 'edit-desconto';
      const valorLiquidoInputId = formType === 'novo' ? 'novo-valorLiquido' : 'edit-valorLiquido';

      document.getElementById(valorTotalInputId).value = '0.00';
      document.getElementById(descontoInputId).value = '0.00';
      document.getElementById(valorLiquidoInputId).value = '0.00';
    }

    async function salvarNovoRelatorio(event) {
      event.preventDefault();
      toggleLoading(true);

      const dataHora = document.getElementById('novo-dataHora').value;
      const tipo = document.getElementById('novo-tipo').value.trim();
      const cliente = document.getElementById('novo-cliente').value.trim();
      const tipoPagamento = document.getElementById('novo-tipoPagamento').value;
      const valorTotal = parseFloat(document.getElementById('novo-valorTotal').value);
      const desconto = parseFloat(document.getElementById('novo-desconto').value);
      const valorLiquido = parseFloat(document.getElementById('novo-valorLiquido').value);

      if (!dataHora || !tipo || !cliente || !tipoPagamento || isNaN(valorTotal) || isNaN(desconto) || isNaN(valorLiquido)) {
        alert('Por favor, preencha todos os campos obrigat√≥rios e certifique-se que os valores s√£o n√∫meros v√°lidos.');
        toggleLoading(false);
        return;
      }

      const itens = [];
      const tabelaItens = document.getElementById('novo-itens-body');
      Array.from(tabelaItens.rows).forEach(row => {
        // Ignora a linha de "nenhum item"
        if (row.querySelector('td[colspan="9"]')) return;

        const item = {};
        item.codigo = row.querySelector('input[data-field="codigo"]').value.trim();
        item.produtoServico = row.querySelector('input[data-field="produtoServico"]').value.trim();
        item.animal = row.querySelector('input[data-field="animal"]').value.trim();
        item.funcionario = row.querySelector('input[data-field="funcionario"]').value.trim();
        item.valorUnitario = parseFloat(row.querySelector('input[data-field="valorUnitario"]').value || 0);
        item.quantidade = parseInt(row.querySelector('input[data-field="quantidade"]').value || 0);
        item.desconto = parseFloat(row.querySelector('input[data-field="desconto"]').value || 0);
        item.liquido = parseFloat(row.querySelector('[data-field="liquido"]').textContent || 0);

        // Valida√ß√£o m√≠nima para um item
        if (!item.produtoServico || isNaN(item.valorUnitario) || isNaN(item.quantidade) || isNaN(item.desconto)) {
            console.warn("Item inv√°lido encontrado e ignorado:", item);
            return;
        }
        itens.push(item);
      });

      if (itens.length === 0) {
        alert('Por favor, adicione pelo menos um item ao relat√≥rio antes de salvar.');
        toggleLoading(false);
        return;
      }

      try {
        await db.collection("relatorios_vendas").add({
          dataHora: dataHora, // Salva como string ISO 8601
          tipo: tipo,
          cliente: cliente,
          tipoPagamento: tipoPagamento,
          valorTotal: valorTotal,
          desconto: desconto,
          valorLiquido: valorLiquido,
          itens: itens,
          timestamp: firebase.firestore.FieldValue.serverTimestamp() // Timestamp do servidor
        });
        alert('Novo relat√≥rio salvo com sucesso!');
        fecharFormularioAtivo();
        carregarRelatorios(); // Recarrega diretamente
      } catch (error) {
        console.error("Erro ao salvar novo relat√≥rio:", error);
        alert('Erro ao salvar novo relat√≥rio. Tente novamente. Detalhes no console.');
      } finally {
        toggleLoading(false);
      }
    }

    async function salvarEdicaoRelatorio(event) {
      event.preventDefault();
      toggleLoading(true);

      if (!idRelatorioEdicao) {
        alert('Nenhum relat√≥rio selecionado para edi√ß√£o.');
        toggleLoading(false);
        return;
      }

      const dataHora = document.getElementById('edit-dataHora').value;
      const tipo = document.getElementById('edit-tipo').value.trim();
      const cliente = document.getElementById('edit-cliente').value.trim();
      const tipoPagamento = document.getElementById('edit-tipoPagamento').value;
      const valorTotal = parseFloat(document.getElementById('edit-valorTotal').value);
      const desconto = parseFloat(document.getElementById('edit-desconto').value);
      const valorLiquido = parseFloat(document.getElementById('edit-valorLiquido').value);

      if (!dataHora || !tipo || !cliente || !tipoPagamento || isNaN(valorTotal) || isNaN(desconto) || isNaN(valorLiquido)) {
        alert('Por favor, preencha todos os campos obrigat√≥rios e certifique-se que os valores s√£o n√∫meros v√°lidos.');
        toggleLoading(false);
        return;
      }

      const itensAtualizados = [];
      const tabelaItens = document.getElementById('edit-itens-body');
      Array.from(tabelaItens.rows).forEach(row => {
        // Ignora a linha de "nenhum item"
        if (row.querySelector('td[colspan="9"]')) return;

        const item = {};
        item.codigo = row.querySelector('input[data-field="codigo"]').value.trim();
        item.produtoServico = row.querySelector('input[data-field="produtoServico"]').value.trim();
        item.animal = row.querySelector('input[data-field="animal"]').value.trim();
        item.funcionario = row.querySelector('input[data-field="funcionario"]').value.trim();
        item.valorUnitario = parseFloat(row.querySelector('input[data-field="valorUnitario"]').value || 0);
        item.quantidade = parseInt(row.querySelector('input[data-field="quantidade"]').value || 0);
        item.desconto = parseFloat(row.querySelector('input[data-field="desconto"]').value || 0);
        item.liquido = parseFloat(row.querySelector('[data-field="liquido"]').textContent || 0);

        // Valida√ß√£o m√≠nima para um item
        if (!item.produtoServico || isNaN(item.valorUnitario) || isNaN(item.quantidade) || isNaN(item.desconto)) {
            console.warn("Item inv√°lido encontrado e ignorado:", item);
            return;
        }
        itensAtualizados.push(item);
      });

      if (itensAtualizados.length === 0) {
        alert('Por favor, adicione pelo menos um item ao relat√≥rio antes de salvar a edi√ß√£o.');
        toggleLoading(false);
        return;
      }

      try {
        await db.collection("relatorios_vendas").doc(idRelatorioEdicao).update({
          dataHora: dataHora, // Salva como string ISO 8601
          tipo: tipo,
          cliente: cliente,
          tipoPagamento: tipoPagamento,
          valorTotal: valorTotal,
          desconto: desconto,
          valorLiquido: valorLiquido,
          itens: itensAtualizados,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp() // Atualiza o timestamp
        });
        alert('Relat√≥rio atualizado com sucesso!');
        fecharFormularioAtivo();
        carregarRelatorios(); // Recarrega diretamente
      } catch (error) {
        console.error("Erro ao atualizar relat√≥rio:", error);
        alert('Erro ao atualizar relat√≥rio. Tente novamente. Detalhes no console.');
      } finally {
        toggleLoading(false);
      }
    }

    function fecharFormularioAtivo() {
      document.getElementById('form-edicao-relatorio').classList.add('hidden');
      document.getElementById('form-novo-relatorio').classList.add('hidden');
      document.getElementById('lista-relatorios').classList.remove('hidden');
      // Garante que o ID de edi√ß√£o √© nulo e o modo de formul√°rio √© limpo
      idRelatorioEdicao = null;
      modoFormulario = '';
      // N√£o reseta os formul√°rios aqui, pois eles ser√£o resetados ao serem abertos novamente
    }

    // Alternar tema claro/escuro
    function alternarTema() {
      document.documentElement.classList.toggle('dark');
      const isDarkMode = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    // Fun√ß√£o para rolar para o topo
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
  </script>
</head>
<body class="bg-gray-50 text-purple-900 font-sans dark:bg-gray-900 dark:text-white min-h-screen flex flex-col">
  <header class="bg-purple-700 text-white p-4 shadow-md">
    <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
      <div class="flex items-center mb-4 sm:mb-0">
        <img src="image_c5c675.png" alt="PetCl√≠nica S√£o L√°zaro Logo" class="h-10 mr-3 object-contain">
        <h1 class="text-2xl font-bold">Relat√≥rios de Vendas</h1>
      </div>
      <nav class="flex flex-wrap justify-center sm:justify-end items-center space-x-4">
        <a href="index.html" class="hover:underline text-white/90">Dashboard</a>
        <a href="admin.html" class="hover:underline text-white/90">Administrativo</a>
        <button onclick="logout()" class="bg-white text-purple-700 px-4 py-2 rounded-full hover:bg-purple-100 transition duration-300 ease-in-out shadow-lg">
          Sair
        </button>
      </nav>
    </div>
  </header>

  <main class="flex-grow container mx-auto p-6 md:p-8 relative">
    <section class="mb-8">
      <h2 class="text-3xl font-bold text-purple-800 dark:text-purple-400 mb-6 text-center">Gest√£o de Relat√≥rios de Vendas</h2>
      <p class="text-lg text-gray-700 dark:text-gray-300 text-center max-w-2xl mx-auto">Visualize, baixe e edite os relat√≥rios de vendas da cl√≠nica.</p>
    </section>

    <div class="flex justify-end mb-6" id="action-buttons">
      <button onclick="abrirFormularioNovoRelatorio()" class="bg-purple-600 text-white px-6 py-3 rounded-full hover:bg-purple-700 transition duration-300 ease-in-out shadow-lg text-lg">
        ‚ûï Novo Relat√≥rio de Vendas
      </button>
    </div>

    <div id="lista-relatorios" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h3 class="text-2xl font-semibold text-purple-700 dark:text-purple-300 mb-4 border-b-2 border-purple-200 dark:border-purple-700 pb-2">Lista de Relat√≥rios Gerados</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full text-left border border-purple-300 dark:border-gray-700">
          <thead class="bg-purple-200 dark:bg-purple-800">
            <tr>
              <th class="p-3 border border-purple-300 dark:border-gray-600">Data/Hora</th>
              <th class="p-3 border border-purple-300 dark:border-gray-600">Tipo</th>
              <th class="p-3 border border-purple-300 dark:border-gray-600">Cliente</th>
              <th class="p-3 border border-purple-300 dark:border-gray-600">Tipo Pagamento</th>
              <th class="p-3 border border-purple-300 dark:border-gray-600">Valor Total</th>
              <th class="p-3 border border-purple-300 dark:border-gray-600">Desconto</th>
              <th class="p-3 border border-purple-300 dark:border-gray-600">Valor L√≠quido</th>
              <th class="p-3 border border-purple-300 dark:border-gray-600">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabela-relatorios" class="bg-white dark:bg-gray-700 dark:text-white">
            </tbody>
        </table>
      </div>
    </div>

    <div id="form-novo-relatorio" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h3 class="text-2xl font-semibold text-purple-700 dark:text-purple-300 mb-4 border-b-2 border-purple-200 dark:border-purple-700 pb-2">Registrar Novo Relat√≥rio de Vendas</h3>
      <form onsubmit="salvarNovoRelatorio(event)" class="space-y-4">
        <div>
          <label for="novo-dataHora" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data e Hora:</label>
          <input type="datetime-local" id="novo-dataHora" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
        </div>
        <div>
          <label for="novo-tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo (ex: Venda, Or√ßamento):</label>
          <input type="text" id="novo-tipo" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" value="Venda" required>
        </div>
        <div>
          <label for="novo-cliente" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Cliente:</label>
          <input type="text" id="novo-cliente" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
        </div>
        <div>
          <label for="novo-tipoPagamento" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Pagamento:</label>
          <select id="novo-tipoPagamento" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
            <option value="Dinheiro">Dinheiro</option>
            <option value="CartaoCredito">Cart√£o de Cr√©dito</option>
            <option value="CartaoDebito">Cart√£o de D√©bito</option>
            <option value="Pix">Pix</option>
            <option value="Boleto">Boleto</option>
            <option value="Transferencia">Transfer√™ncia Banc√°ria</option>
            <option value="Outro">Outro</option>
          </select>
        </div>

        <h4 class="text-xl font-semibold text-purple-600 dark:text-purple-400 mt-6 mb-3">Itens do Relat√≥rio</h4>
        <div class="overflow-x-auto border border-purple-300 dark:border-gray-600 rounded-lg">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-purple-100 dark:bg-purple-700">
              <tr>
                <th class="px-2 py-2 border dark:border-gray-600">C√≥d.</th>
                <th class="px-2 py-2 border dark:border-gray-600">Produto / Servi√ßo</th>
                <th class="px-2 py-2 border dark:border-gray-600">Animal</th>
                <th class="px-2 py-2 border dark:border-gray-600">Funcion√°rio</th>
                <th class="px-2 py-2 border dark:border-gray-600">Valor Unit.</th>
                <th class="px-2 py-2 border dark:border-gray-600">Qtd.</th>
                <th class="px-2 py-2 border dark:border-gray-600">Desc.</th>
                <th class="px-2 py-2 border dark:border-gray-600">L√≠quido</th>
                <th class="px-2 py-2 border dark:border-gray-600 text-center">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="novo-itens-body" class="bg-white dark:bg-gray-700 dark:text-white">
              <tr><td colspan="9" class="p-4 text-center text-gray-500 dark:text-gray-400">Nenhum item neste relat√≥rio. Clique em "Adicionar Item" para come√ßar.</td></tr>
            </tbody>
          </table>
        </div>
        <button type="button" onclick="abrirModalAdicionarItem()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out mt-4">
          + Adicionar Novo Item
        </button>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div>
            <label for="novo-valorTotal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor Total:</label>
            <input type="number" step="0.01" id="novo-valorTotal" class="input mt-1 block w-full bg-gray-100 dark:bg-gray-900 border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 cursor-not-allowed" value="0.00" readonly>
          </div>
          <div>
            <label for="novo-desconto" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Desconto Total:</label>
            <input type="number" step="0.01" id="novo-desconto" class="input mt-1 block w-full bg-gray-100 dark:bg-gray-900 border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 cursor-not-allowed" value="0.00" readonly>
          </div>
          <div>
            <label for="novo-valorLiquido" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor L√≠quido:</label>
            <input type="number" step="0.01" id="novo-valorLiquido" class="input mt-1 block w-full bg-gray-100 dark:bg-gray-900 border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 cursor-not-allowed" value="0.00" readonly>
          </div>
        </div>

        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" onclick="fecharFormularioAtivo()" class="bg-gray-400 text-white px-6 py-2 rounded-full hover:bg-gray-500 transition duration-300 ease-in-out">
            Cancelar
          </button>
          <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-full hover:bg-purple-700 transition duration-300 ease-in-out">
            Salvar Novo Relat√≥rio
          </button>
        </div>
      </form>
    </div>

    <div id="form-edicao-relatorio" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
      <h3 class="text-2xl font-semibold text-purple-700 dark:text-purple-300 mb-4 border-b-2 border-purple-200 dark:border-purple-700 pb-2">Editar Relat√≥rio de Vendas</h3>
      <form onsubmit="salvarEdicaoRelatorio(event)" class="space-y-4">
        <div>
          <label for="edit-dataHora" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data e Hora:</label>
          <input type="datetime-local" id="edit-dataHora" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
        </div>
        <div>
          <label for="edit-tipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo:</label>
          <input type="text" id="edit-tipo" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
        </div>
        <div>
          <label for="edit-cliente" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Cliente:</label>
          <input type="text" id="edit-cliente" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
        </div>
        <div>
          <label for="edit-tipoPagamento" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Pagamento:</label>
          <select id="edit-tipoPagamento" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
            <option value="Dinheiro">Dinheiro</option>
            <option value="CartaoCredito">Cart√£o de Cr√©dito</option>
            <option value="CartaoDebito">Cart√£o de D√©bito</option>
            <option value="Pix">Pix</option>
            <option value="Boleto">Boleto</option>
            <option value="Transferencia">Transfer√™ncia Banc√°ria</option>
            <option value="Outro">Outro</option>
          </select>
        </div>

        <h4 class="text-xl font-semibold text-purple-600 dark:text-purple-400 mt-6 mb-3">Itens do Relat√≥rio</h4>
        <div class="overflow-x-auto border border-purple-300 dark:border-gray-600 rounded-lg">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-purple-100 dark:bg-purple-700">
              <tr>
                <th class="px-2 py-2 border dark:border-gray-600">C√≥d.</th>
                <th class="px-2 py-2 border dark:border-gray-600">Produto / Servi√ßo</th>
                <th class="px-2 py-2 border dark:border-gray-600">Animal</th>
                <th class="px-2 py-2 border dark:border-gray-600">Funcion√°rio</th>
                <th class="px-2 py-2 border dark:border-gray-600">Valor Unit.</th>
                <th class="px-2 py-2 border dark:border-gray-600">Qtd.</th>
                <th class="px-2 py-2 border dark:border-gray-600">Desc.</th>
                <th class="px-2 py-2 border dark:border-gray-600">L√≠quido</th>
                <th class="px-2 py-2 border dark:border-gray-600 text-center">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="edit-itens-body" class="bg-white dark:bg-gray-700 dark:text-white">
              </tbody>
          </table>
        </div>
        <button type="button" onclick="abrirModalAdicionarItem()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out mt-4">
          + Adicionar Novo Item
        </button>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div>
            <label for="edit-valorTotal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor Total:</label>
            <input type="number" step="0.01" id="edit-valorTotal" class="input mt-1 block w-full bg-gray-100 dark:bg-gray-900 border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 cursor-not-allowed" readonly>
          </div>
          <div>
            <label for="edit-desconto" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Desconto Total:</label>
            <input type="number" step="0.01" id="edit-desconto" class="input mt-1 block w-full bg-gray-100 dark:bg-gray-900 border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 cursor-not-allowed" readonly>
          </div>
          <div>
            <label for="edit-valorLiquido" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor L√≠quido:</label>
            <input type="number" step="0.01" id="edit-valorLiquido" class="input mt-1 block w-full bg-gray-100 dark:bg-gray-900 border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 cursor-not-allowed" readonly>
          </div>
        </div>

        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" onclick="fecharFormularioAtivo()" class="bg-gray-400 text-white px-6 py-2 rounded-full hover:bg-gray-500 transition duration-300 ease-in-out">
            Cancelar
          </button>
          <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded-full hover:bg-purple-700 transition duration-300 ease-in-out">
            Salvar Altera√ß√µes
          </button>
        </div>
      </form>
    </div>
  </main>

  <div id="modal-adicionar-item" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md relative">
      <h3 class="text-xl font-semibold text-purple-700 dark:text-purple-300 mb-4 border-b-2 border-purple-200 dark:border-purple-700 pb-2">Adicionar Novo Item</h3>
      <form id="novo-item-form-modal" onsubmit="event.preventDefault(); adicionarItemDoModal()" class="space-y-3">
        <div>
          <label for="novo-item-codigo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">C√≥digo:</label>
          <input type="text" id="novo-item-codigo" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label for="novo-item-produtoServico" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Produto / Servi√ßo:</label>
          <input type="text" id="novo-item-produtoServico" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" required>
        </div>
        <div>
          <label for="novo-item-animal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Animal:</label>
          <input type="text" id="novo-item-animal" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label for="novo-item-funcionario" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Funcion√°rio:</label>
          <input type="text" id="novo-item-funcionario" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white">
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div>
            <label for="novo-item-valorUnitario" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor Unit.:</label>
            <input type="number" step="0.01" id="novo-item-valorUnitario" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" value="0.00" onchange="calcularLiquidoNovoItem()" required>
          </div>
          <div>
            <label for="novo-item-quantidade" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Qtd.:</label>
            <input type="number" step="1" id="novo-item-quantidade" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" value="1" onchange="calcularLiquidoNovoItem()" required>
          </div>
          <div>
            <label for="novo-item-desconto" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Desconto:</label>
            <input type="number" step="0.01" id="novo-item-desconto" class="input mt-1 block w-full border border-purple-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white" value="0.00" onchange="calcularLiquidoNovoItem()" required>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">L√≠quido do Item:</label>
          <p id="novo-item-liquido" class="text-lg font-bold text-purple-600 dark:text-purple-400 mt-1">0.00</p>
        </div>

        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="fecharModalAdicionarItem()" class="bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500 transition">
            Cancelar
          </button>
          <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">
            Adicionar ao Relat√≥rio
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[100]">
    <div class="flex flex-col items-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
      <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600"></div>
      <p class="mt-4 text-lg font-medium text-purple-700 dark:text-purple-300">Processando...</p>
      <p class="text-sm text-gray-500 dark:text-gray-400">Por favor, aguarde.</p>
    </div>
  </div>

  <button id="back-to-top" onclick="scrollToTop()" class="hidden fixed bottom-20 right-4 bg-purple-600 text-white p-3 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 ease-in-out z-40">
    ‚¨ÜÔ∏è Voltar ao Topo
  </button>

  <button onclick="alternarTema()" class="fixed bottom-4 left-4 bg-gray-800 text-white px-5 py-3 rounded-full shadow-lg hover:bg-gray-700 dark:bg-white dark:text-gray-900 transition duration-300 ease-in-out text-lg">
    üåì Tema
  </button>
</body>
</html>